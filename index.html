<html>
<head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <script>
        AFRAME.registerComponent('rotation-reader', {
            tick: (function () {
                var position = new THREE.Vector3();
                var quaternion = new THREE.Quaternion();

                return function () {
                    this.el.object3D.getWorldPosition(position);
                    this.el.object3D.getWorldQuaternion(quaternion);

                    console.log('Posizione:', position);
                    console.log('Rotazione (quaternion):', quaternion);
                };
            })()
        });

        AFRAME.registerComponent('move-to-position', {
            schema: {
                target: {type: 'vec3'}
            },
            init: function () {
                var el = this.el;
                var cameraEl = document.querySelector('[camera]');

                el.addEventListener('click', function (evt) {
                    var targetPosition = evt.detail.intersection.point;

                    cameraEl.setAttribute('animation', {
                        property: 'position',
                        to: targetPosition.x + ' ' + 2 + ' ' + targetPosition.z,
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                });
            }
        });

        AFRAME.registerComponent('open-text-window', {
            schema: {
                message: {type: 'string', default: ''}
            },
            init: function () {
                var el = this.el;
                var data = this.data;

                el.addEventListener('click', function () {
                    var existingText = document.querySelector('#text-message');
                    if (existingText) {
                        existingText.parentNode.removeChild(existingText);
                    }

                    var textEntity = document.createElement('a-entity');
                    textEntity.setAttribute('id', 'text-message');
                    textEntity.setAttribute('geometry', 'primitive: plane; height: auto; width: auto');
                    textEntity.setAttribute('material', 'color: white');
                    textEntity.setAttribute('text', {
                        value: data.message,
                        color: 'black',
                        width: 4,
                        align: 'center'
                    });

                    var cameraEl = document.querySelector('[camera]');
                    var cameraPosition = cameraEl.object3D.position;

                    textEntity.setAttribute('position', {
                        x: cameraPosition.x,
                        y: cameraPosition.y + 2,
                        z: cameraPosition.z - 3
                    });

                    textEntity.setAttribute('follow-camera', '');
                    document.querySelector('a-scene').appendChild(textEntity);
                });
            }
        });

        AFRAME.registerComponent('hover-color', {
            schema: {
                color: {type: 'color', default: '#7BC8A4'},
                originalColor: {type: 'color', default: '#7BC8A4'}
            },
            init: function () {
                var el = this.el;
                var data = this.data;

                el.addEventListener('mouseenter', function () {
                    el.setAttribute('material', 'color', data.color);
                });

                el.addEventListener('mouseleave', function () {
                    el.setAttribute('material', 'color', data.originalColor);
                });
            }
        });

        AFRAME.registerComponent('open-image', {
            schema: {
                src: {type: 'string'}
            },
            init: function () {
                var el = this.el;
                var data = this.data;

                el.addEventListener('click', function () {
                    var existingImage = document.querySelector('#image-popup');
                    if (existingImage) {
                        existingImage.parentNode.removeChild(existingImage);
                    }

                    var imageEntity = document.createElement('a-image');
                    imageEntity.setAttribute('id', 'image-popup');
                    imageEntity.setAttribute('src', data.src);
                    imageEntity.setAttribute('width', '4');  // Larghezza dell'immagine
                    imageEntity.setAttribute('height', '3'); // Altezza dell'immagine

                    var cameraEl = document.querySelector('[camera]');
                    var cameraPosition = cameraEl.object3D.position;

                    imageEntity.setAttribute('position', {
                        x: cameraPosition.x,
                        y: cameraPosition.y + 2,
                        z: cameraPosition.z - 4
                    });

                    document.querySelector('a-scene').appendChild(imageEntity);
                });
            }
        });

        AFRAME.registerComponent('follow-camera', {
            tick: function () {
                var cameraEl = document.querySelector('[camera]');
                var cameraPosition = cameraEl.object3D.position;

                this.el.object3D.position.set(
                    cameraPosition.x,
                    cameraPosition.y + 2,
                    cameraPosition.z - 3
                );
            }
        });
    </script>
</head>
<body>
    <a-scene>
        <a-assets>
            <a-asset-item id="my-model" src="assets/GPS/PIAZZALE SANTUARIO Definitivo.glb"></a-asset-item>
            <a-asset-item id="contesto" src="assets/GPS/PIAZZALE SANTUARIO contesto esterno.glb"></a-asset-item>
            <a-asset-item id="my-image" src="assets/GPS/sky.png"></a-asset-item>
        </a-assets>

        <!-- Modello 3D che apre un'immagine al clic -->
        <a-entity class="clickable" position="0 0.1 -3" rotation="0 90 0" scale="1 1 1" 
                  gltf-model="#my-model" rotation-reader move-to-position
                  open-image="src: #my-image"
                  open-text-window="message: This is my GLB model!">
        </a-entity>

        <!-- Piano interattivo -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="40" height="80" color="#DEDEDE" class="clickable" move-to-position hover-color></a-plane>

        <a-sky color="#079FE2"></a-sky>

        <!-- Camera -->
        <a-entity camera look-controls wasd-controls position="-4 2 37">
            <a-cursor id="cursor" raycaster="objects: .clickable" fuse="false"></a-cursor>
        </a-entity>
    </a-scene>
</body>
</html>
